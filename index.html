<!DOCTYPE html>
<html lang="en" >
<head>
  <title>Stratego - capture the flag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">

  <style>
    body {
      font-family: Arial, sans-serif;
    }  
	  
    .menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;      
	    background-color: transparent;
    }

    .menu > * {
      margin-bottom: 15px;
      font-size: 25px;
    }

    .menu-title {
      font-size: 20px;
      font-weight: 700;
      justify-content: center;
      align-items: center;
      text-align: center;	  
    }
	
    .menu-title2 {
      font-size: 20px;
      justify-content: center;
      align-items: center;
      text-align: center;	  
    }

    .menu-waiting-message {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;	  
      background-color: transparent;
      height: 70vh;
    }
	
    #game {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #gameBOARD {
      width: 95vw;
      height: 95vw;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
    }

    .square {
      border: 1px solid #ccc;
      width: 95vw/10;
      height: 95vw/10;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .square:nth-child(odd):nth-of-type(odd),
      .square:nth-child(even):nth-of-type(even) {
      background-color: #fff;
    }
	
    .buttonDone-style {
      font-size: 20px;
      font-weight: 700;
    }

    .outcome-banner {
      position: fixed; /* To appear on top of other elements */
      top: 35vh;
      left: 0;
      width: 100%;
      height: 60px; /* Adjust height as needed */
      background-color: gray;
      text-align: center;
      color: white; /* Assumes white text on gray background */
      font-size: 21px;
      font-weight: 700;
      line-height: 50px; /* Center text vertically within banner */
      z-index: 10; /* Ensure it appears on top of other elements */
    }
  </style>

</head>

<body>
  <!-- <button onclick="test()">test</button>	-->
  <div id="menu" class="menu">
    <p class="menu-title">Stratego - capture the flag</p>
    <input id="inputPLAYER_NAME" type="text" placeholder="Enter your name...">
    <button id="readyButton" onclick="ready()" class="menu-button">Ready</button>	
	<p class="menu-title2">(version 1.12)</p>
  </div>  
  
  <div id="menuWAITING" class="menu-waiting-message">
    <p>WAITING FOR HOST...</p>
  </div>
  
  <div id="game" >  
    <p id="playerNAME" >player:</P>
    <div id="gameBOARD"></div>
	<p id="lableSetup1">Click the square to place your 1</P><p id="lableSetup2">x1 left</p>
  </div>	

  <div id="lableOutcome" class="outcome-banner" style="display: none">Outcome: #</div> <!-- Block -->

  <button onclick="clearKeys()" style="bottom: 10px; position: fixed;">Force New Game</button>


  <script>    
    const lableOutcome = document.getElementById("lableOutcome");
    var playerTurn = true;
    var playerTurnHold = false;
    var playerReady = false;
    var playerSetup = false;
    var playerSelectID = false;
    var playerSelectRow = false;
    var playerSelectCol = false;
    var rowNumber;
    var columnNumber;
    var selectedSquareDocument;
    var playerNAME = false;
    var currentNumber = 1;
    var currentNumberCount = 1;
    var lableOutcomeShown = false;
    var lableOutcomeTimerCount = 0;
	
	//ready();
	
// ---------------------------------------------------------------------------------- CHECK() Player Turn / Display Outcome | 5 seconds

  setInterval(function() {

// === check Display     

    if (lableOutcomeShown == true) {
      if (lableOutcomeTimerCount == 0) {
        lableOutcomeTimerCount = 1;
      } else {
        lableOutcomeTimerCount = 0;
        lableOutcome.innerText = "";
        lableOutcome.style.display = "none";
        lableOutcomeShown = false;
      }
    }

  // === Check move 

    if (playerTurn == false && playerTurnHold == false) {
      google.script.run.withSuccessHandler(function(response) {
        if (response.msg == 'first') { 
          document.getElementById("lableSetup1").innerText = "Your Turn!";
          playerTurn = true;
        } else if (response.msg == "yt") {
          document.getElementById("lableSetup1").innerText = "Your Turn!";
          playerTurn = true;        
          //alert("yt:\n" + response.lastMove);
          var split = response.lastMove.split(",");
          var checkMSG = split[0];
          var checkAttackerPieceType = split[1];
          var checkDefenderPieceType = split[2];
          //alert(checkMSG + "\nAttacker: " + checkAttackerPieceType + "\nDefender" + checkDefenderPieceType);
          var checkPlayerSelectRow = (9-split[3]).toString();
          var checkPlayerSelectCol = (9-split[4]).toString();
          var checkRowNumber = (9-split[5]).toString();
          var checkColumnNumber = (9-split[6]).toString();
          var checkPlayerSelectSquare = "square-" + checkPlayerSelectRow + "-" + checkPlayerSelectCol;
          var checkPlayerSquare = "square-" + checkRowNumber + "-" + checkColumnNumber;
          //alert("playerSelectRow: " + checkPlayerSelectRow + "\nplayerSelectCol: " + checkPlayerSelectCol + "\nRownum: " + checkRowNumber + "\nColumnNum: " + checkColumnNumber);
        // NA
          if (checkMSG == "na") {
            document.getElementById(checkPlayerSelectSquare).style.backgroundColor = "darkgray";
            document.getElementById(checkPlayerSquare).style.backgroundColor = "red";
            setTimeout(function() {
              document.getElementById(checkPlayerSelectSquare).style.backgroundColor = "white";
              document.getElementById(checkPlayerSquare).style.backgroundColor = "darkred";
            }, 5000);
        // You Both LOSE
          } else if (checkMSG == "draw") {
            document.getElementById(checkPlayerSelectSquare).innerText = checkAttackerPieceType;
            document.getElementById(checkPlayerSquare).style.background = "orange";

            setTimeout(function() {
              document.getElementById(checkPlayerSelectSquare).innerText = "";
              document.getElementById(checkPlayerSelectSquare).style.backgroundColor = "white";
              document.getElementById(checkPlayerSquare).innerText = "";
              document.getElementById(checkPlayerSquare).style.backgroundColor = "white";
            }, 5000);
        // You LOSE
          } else if (checkMSG == "win") {
            document.getElementById(checkPlayerSelectSquare).innerText = checkAttackerPieceType;
            document.getElementById(checkPlayerSquare).style.background = "orange";

            setTimeout(function() {
              document.getElementById(checkPlayerSelectSquare).innerText = "";
              document.getElementById(checkPlayerSelectSquare).style.backgroundColor = "white";
              document.getElementById(checkPlayerSquare).innerText = "";
              document.getElementById(checkPlayerSquare).style.backgroundColor = "darkred";
            }, 5000);
        // you WIN
          } else if (checkMSG == "lose") {
            document.getElementById(checkPlayerSelectSquare).innerText = checkAttackerPieceType;
            document.getElementById(checkPlayerSquare).style.background = "orange";

            setTimeout(function() {
              document.getElementById(checkPlayerSelectSquare).innerText = "";
              document.getElementById(checkPlayerSelectSquare).style.backgroundColor = "white";
              document.getElementById(checkPlayerSquare).style.backgroundColor = "lightblue";
            }, 5000);            
          } else if (checkMSG == "winGame") {
            document.getElementById("lableSetup1").innerText = "YOU LOST :(";
            playerTurnHold = true; 
            document.getElementById("lableSetup1").innerText = "YOU LOSE :(";
            lableOutcome.innerText = "YOU LOSE :(";         
            lableOutcome.style.display = "block";
            clearKeys();
          } else {
            alert("ERROR: checkMSG error = " + checkMSG);
          }
          
        } else if (response == 'setup') {
          document.getElementById("lableSetup1").innerText = "Waiting for other player...";
        } else {
          document.getElementById("lableSetup1").innerText = "Wait for your turn...";
        }
      }).check({playerName: playerNAME});
    }

  }, 5000);    

// ------------------------------------------------------------------------------------------------------------------------ Game SETUP 

	function gameStart() {
	  document.getElementById("menuWAITING").style.display = "none";
	  document.getElementById("game").style.display = "flex";
	  // Make Board
	  const board = document.getElementById("gameBOARD");
	  for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        const square = document.createElement("div");
        square.classList.add("square");
        square.id = `square-${row}-${col}`; // Unique ID for each square
        board.appendChild(square);
      }
	  }
	  const squares = document.querySelectorAll(".square");
	  squares.forEach(square => {
		square.addEventListener("click", handleSquareClick);
	  });
	  // Setup Board Water
	  const squareIds = [
	    "square-4-2",
	    "square-5-2",
	    "square-4-3",
	    "square-5-3",
		  "square-4-6",
	    "square-5-6",
	    "square-4-7",
	    "square-5-7",
	  ];
	  for (const id of squareIds) {
	    const targetSquare = document.getElementById(id);
	    targetSquare.style.backgroundColor = "gray";
		  targetSquare.innerText = "#";
	  }
    for (let row = 0; row < 4; row++) {
      for (let col = 0; col < 10; col++) {
        var tempID = "square-" + row + "-" + col;
        var temp = document.getElementById(tempID);
        temp.style.backgroundColor = "darkred";
      }
    }
	}		

// ------------------------------------------------------------------------------------------------------------------------ on Board CLICK

	function handleSquareClick(event) {
	  const selectedSquareId = event.target.id;
	  const selectedSquareDocument = document.getElementById(selectedSquareId);
	  const rowNumber = selectedSquareId.split("-")[1];
	  const columnNumber = selectedSquareId.split("-")[2];
	  const selectedType = selectedSquareDocument.innerText;
	  if (playerSelectID != false) { 
		  const movingPieceType = document.getElementById(playerSelectID).innerText;
	  }
	  
	  // Clicking because to move the peace
	  if (playerSetup == true && playerTurn == true) { 
      var peaceType = selectedSquareDocument.innerText;
      var peaceColor = selectedSquareDocument.style.backgroundColor;
      
      if (playerSelectID != false) { movingPieceType = document.getElementById(playerSelectID).innerText; }
      else { movingPieceType = false }

      if (peaceColor == "lightblue" && playerSelectID == false && selectedType != "B" && selectedType != "F" ) {
        playerSelectID = selectedSquareId;
        playerSelectRow = rowNumber;
        playerSelectCol = columnNumber;
        selectedSquareDocument.style.color = "red";
      } else if (peaceColor == "lightblue" && selectedType != "B" && selectedType != "F") {
        document.getElementById(playerSelectID).style.color = "black";
        playerSelectID = selectedSquareId;
        playerSelectRow = rowNumber;
        playerSelectCol = columnNumber;
        selectedSquareDocument.style.color = "red";
      // Moving Anything but a 2, #, B or F
      } else if (Math.abs(rowNumber - playerSelectRow) + Math.abs(columnNumber - playerSelectCol) === 1
      && selectedType != "#" && movingPieceType != "2" && selectedType != "B" && selectedType != "F") {
        _move(selectedSquareDocument, playerSelectRow, playerSelectCol, rowNumber, columnNumber);
      // Moving a 2  
      } else if (movingPieceType == "2" && (Math.abs(columnNumber - playerSelectCol) <= 1 || Math.abs(rowNumber - playerSelectRow) <= 1 ) 
      && selectedType != "#" ) {
        // Check if the move is within the same row and doesn't encounter obstacles
        if (!hasObstaclesInPath(rowNumber, columnNumber, playerSelectRow, playerSelectCol, selectedSquareId )) {          
          _move(selectedSquareDocument, playerSelectRow, playerSelectCol, rowNumber, columnNumber);
        }
      }
	  }
	  
	// Clicking because to setup the game
	  if (playerSetup == false) {
		  if (rowNumber >= 6 && rowNumber <= 9) {
        if (selectedSquareDocument.innerText == "") {
          selectedSquareDocument.innerText = currentNumber;
          selectedSquareDocument.style.backgroundColor = "lightBlue";
          currentNumberCount = currentNumberCount - 1;
          if (currentNumberCount <= 0) { 
          if (currentNumber == 1) { currentNumberCount = 8; currentNumber+=1; } // 2
          else if (currentNumber == 2) { currentNumberCount = 5; currentNumber+=1; } // 3 
          else if (currentNumber == 3) { currentNumberCount = 4; currentNumber+=1; }
          else if (currentNumber == 4) { currentNumberCount = 4; currentNumber+=1; }
          else if (currentNumber == 5) { currentNumberCount = 4; currentNumber+=1; }
          else if (currentNumber == 6) { currentNumberCount = 3; currentNumber+=1; }
          else if (currentNumber == 7) { currentNumberCount = 2; currentNumber+=1; }
          else if (currentNumber == 8) { currentNumberCount = 1; currentNumber+=1; }
          else if (currentNumber == 9) { currentNumberCount = 1; currentNumber+=1; }
          else if (currentNumber == 10) { currentNumberCount = 6; currentNumber = "B"; }
          else if (currentNumber == "B") { currentNumberCount = 1; currentNumber = "F";}
          else if (currentNumber == "F") { currentNumber = "done"; currentNumberCount = 0; playerSetup = true; }
          else { alert("ERROR 348756345"); }
          
          if (playerSetup == false) { document.getElementById("lableSetup1").innerText = "Click the square to place your " + currentNumber; }
          else { document.getElementById("lableSetup1").innerText = "Done. (Waiting for HOST)"; }
          }		  
          if (playerSetup == false) { document.getElementById("lableSetup2").innerText = "x" + currentNumberCount + " left"; }
          else { document.getElementById("lableSetup2").style.display = "none"; }
        // If setup is finished, send board data to the server
          if (playerSetup == true) {        
            _sendBoard()
          }
		    }
	    }	
	  }
  }

// ---------------------------------------------------------------------------------------------------------------------------------- MOVE

  function _move(selectedSquareDocument, playerSelectRow, playerSelectCol, rowNumber, columnNumber) {
    playerTurn = false;
    playerTurnHold = true;
    document.getElementById("lableSetup1").innerText = "Moving... (Waiting for HOST)";
    document.getElementById(playerSelectID).style.color = "black";

    google.script.run.withSuccessHandler(function(response) {
      playerTurnHold = false; // server "gamePlayerTurn" has now been updated and your client can now check again
      //alert("_move():\n" + response.msg + "\nattackerPieceType: " + response.attackerPieceType + "\ndefenderPieceType: " + response.defenderPieceType);
      const movingPiece = document.getElementById(playerSelectID);
      if (response.msg == "winGame") { 
        playerTurnHold = true; 
        document.getElementById("lableSetup1").innerText = "YOU WIN!";
        lableOutcome.innerText = "YOU WIN!";         
        lableOutcome.style.display = "block";
        clearKeys();
      } else if (response.msg == "na") {
        selectedSquareDocument.innerText = movingPiece.innerText;
        selectedSquareDocument.style.backgroundColor = "lightblue"; 
        movingPiece.innerText = "";
        movingPiece.style.backgroundColor = "white";        
      } else if (response.msg == "win" || response.msg == "lose" || response.msg == "draw") {
        selectedSquareDocument.innerText = response.defenderPieceType;
        movingPiece.style.background = "orange";
        setTimeout(function() {        
          if (response.msg == "lose") { 
            movingPiece.innerText = "";
            movingPiece.style.backgroundColor = "white"; 
            selectedSquareDocument.innerText = "";
          } else if (response.msg == "draw") {
            selectedSquareDocument.innerText = "";
            selectedSquareDocument.style.backgroundColor = "white"; 
            movingPiece.innerText = "";
            movingPiece.style.backgroundColor = "white"; 
          } else if (response.msg == "win") {
            selectedSquareDocument.innerText = movingPiece.innerText;
            selectedSquareDocument.style.backgroundColor = "lightblue"; 
            movingPiece.innerText = "";
            movingPiece.style.backgroundColor = "white"; 
          }
        }, 5000); 
      }
      playerSelectID = false;
    }).moving(playerNAME, playerSelectRow, playerSelectCol, rowNumber, columnNumber);    
  }

// --------------------------------------------------------------------------------------------------------- Obstacles In Path Check

  function hasObstaclesInPath(row, col, selRow, selCol, selID) {
    if ((row - selRow) == 0) {
      //alert("LR");
      //alert("0 Left/Right: row: " + row + " SelRow: " + SelRow);
      for (let nextCol = Math.min(col, selCol); nextCol <= Math.max(col, selCol); nextCol++) {
        const squareId = `square-${row}-${nextCol}`;
        const square = document.getElementById(squareId);

        if ( squareId != selID ) {
          if (square.innerText === "#" || square.style.backgroundColor === "darkred") {
            return true; // Obstacle found
          }
        }
      }
    } else {
      //alert("UD");
        //alert("UP/DOWN: row: " + row + " SelRow: " + SelRow);
      for (let nextRow = Math.min(row, selRow); nextRow <= Math.max(row, selRow); nextRow++) {
        const squareId = `square-${nextRow}-${col}`;
        const square = document.getElementById(squareId);

        if ( squareId != selID ) {
          if (square.innerText === "#" || square.style.backgroundColor === "darkred") {
            return true; // Obstacle found
          }
        }
      }
    }
    return false; // No obstacles
  } 

// ------------------------------------------------------------------------------------------------------------------- Send the Board layout

  function _sendBoard() {
    playerTurn = false;
    var tempBoard = [];
    for (let row = 0; row < 10; row++) {
      tempBoard[row] = [];
      for (let col = 0; col < 10; col++) {
        var tempID = "square-" + row + "-" + col;
        var temp = document.getElementById(tempID);
        tempBoard[row][col] = temp.innerText;
      }
    }
    google.script.run.withSuccessHandler(function(response) {        
		  
		}).receiveBoard(playerNAME, tempBoard);
  }

// ------------------------------------------------------------------------------------------------------------------------ On Ready	

  function ready() {    
	  var tempDIV = document.getElementById("menu");
	  var tempINPUT = document.getElementById("inputPLAYER_NAME");
	  var tempDIV_WAITING = document.getElementById("menuWAITING");
	  playerNAME = tempINPUT.value;
	  if (playerNAME != "") {
		  playerReady = true;
	      tempDIV.style.display = "none";
		  tempDIV_WAITING.style.display = "flex"; // Waiting for host
		  document.getElementById("playerNAME").innerText = "player: " + playerNAME;

		  // Tell the server player is ready, setup player name, start Game
		  google.script.run.withSuccessHandler(function(response) {
        if (response) { alert(response); }
		    gameStart();
		  }).game({playerName: playerNAME, msg: "ready"});
		} else {
		  alert("Please enter a player name");
		}
  }

 // ------------------------------------------------------------------------------------------------------------------------ clear cach

  function clearKeys() {
    google.script.run.withSuccessHandler(function(response) {
      alert("Game Keys reset");
		}).clear_All();
  }

 // ------------------------------------------------------------------------------------------------------------------------ Testing 

  function test() {
	  for (let row = 6; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        var temp = document.getElementById("square-"+row+"-"+col);
          temp.innerText = 2;
          temp.style.backgroundColor = "lightBlue";
      }
	  }
	  playerSetup = true;
	  document.getElementById("lableSetup2").style.display = "none";
	  document.getElementById("lableSetup1").innerText = "Done. Waiting for HOST";
    _sendBoard();
	}

// ------------------------------------------------------------------------------------------------------------------------ END    
  </script>  
 </body> 
</html>